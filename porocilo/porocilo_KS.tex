\documentclass[a4paper, 11pt]{article}

\usepackage[slovene]{babel}
\usepackage[utf8]{inputenc}
\usepackage[T1]{fontenc}
\usepackage{lmodern}
\usepackage{amsmath}
\usepackage{amsfonts}
\usepackage{amssymb}
\usepackage{enumitem}
\usepackage{epsdice}
\usepackage{array}
\usepackage[table]{xcolor}
\usepackage{makecell}
\usepackage{hyperref}

\usepackage[caption=false]{subfig}

\usepackage{geometry}
\geometry{
 a4paper,
 total={170mm,257mm},
 left=25mm,
 top=25mm,
 }

\newcolumntype{P}[1]{>{\centering\arraybackslash}p{#1}}

\begin{document}

\title{\textbf{\LARGE{Model napovedi odjema električne energije}} \\ Matematika z računalnikom 2023/24}
\author{Karolina Šavli}
\date{Maj 2024}

\maketitle

% =======================================================================================================================
% =======================================================================================================================


\section{Uvod}

Cilj projektne naloge je sestaviti model, ki bo napovedal odjem električne energije 
za celotni naslenji dan (za naslednjih $24$ ur). \\

% =======================================================================================================================

\subsection{Teoretična osnova}

\noindent V projektni nalogi se bomo ukvarjali s časovno vrsto $\{X_t\}_t$, torej nekim zaporedjem podatkov. 
Celotna analiza in napovedovanje 
sta izvedena v programskem jeziku \href{https://www.python.org/}{Python}. Zaradi lažjega razumevanja vsebine si najprej poglejmo
nekaj pomembnih konceptov v okviru časovnih vrst. \\

\noindent Pomemben cilj pri sestavljanju modelov je transformacija časovne vrste v stacionarno.
Časovna vrsta je stacionarna, če ima podobne statistične značilnosti kot vsaka časovno zamaknjena časovna vrsta. 
Ne smemo torej imeti trenda ali sezonskosti.
Stacionarno lahko preverimo z različnimi formalnimi testi, kot so na primer Augmented Dickey-Fuller (ADF) test,
Kwiatkowski-Phillips-Schmidt-Shin (KPSS) test in Phillips-Perron test. \cite{Stacionarity_V,Brilej_2021} 
Pogosti pristopi, da pridemo do stacionarne časovne vrste so logaritmiranje časovne vrste, diferenciranje,
sezonsko diferenciranje , \dots Pri tem si pogosto pomagamo z obravno 
avtokorelacijske funkcije (ACF) in parcialno avtokorelacijske funkcije (PACF). 
Ti funkciji sta pomembni, saj opisujeta korelacijo med podatkovnimi točkami v časovni vrsti in prejšnjimi vrednostmi 
časovne vrste (za različne dolžine zamika). Iz teh funkciji lahko razberemo tudi, če imamo sezonsko komponento.
ACF meri linearno razmerje med opazovanjem in njegovimi prejšnjimi opazovanji pri različnih zamikih. 
PACF pa neposredno meri linearno razmerje med opazovanjem in njegovimi prejšnjimi opazovanji ob določenem zamiku, 
pri čemer so izključeni prispevki iz vmesnih zamikov. \\

\noindent Ker bomo opravka s časovno vrsto, katere lastnosti se s časom ne spreminjajo, bomo
obravnavali model ARMA (ang. \emph{autoregressive moving average process}), ki velja za enega najbolj zanih modelov, ki predpostavlja stacionarno vrsto. 



\noindent Ukvarjali se bomo z modeli družine ARMA in GARCH. 



% =======================================================================================================================
% =======================================================================================================================

\pagebreak

\section{Osnovna analiza časovne vrste}

\noindent Podjetje \href{https://gen-i.si/}{GEN-I} je v obliki excel razpredelnice pripravilo tabelo podatkov, sestavljeno iz sedmih stolpcev:
\begin{itemize}
    \item  \texttt{DateTimeStartUTC}: univerzalni koordinirani čas,
    \item  \texttt{DateTimeStartCET}: srednjeevropski čas,
    \item  \texttt{Odjem ACT}: neto odjem električne energije v kWh,
    \item  \texttt{Temperatura ACT}: dejanska temperatura, 
    \item  \texttt{Temperatura FC}: s strani GEN-I napovedana temperatura,
    \item  \texttt{Sevanje ACT}: dejansko sevanje in
    \item  \texttt{Sevanje FC}: s strani GEN-I napovedano sevanje. 
\end{itemize}

\begin{figure}[h!]
    \centering
    \caption{Tabela podatkov, 2021-2024}\par\medskip
    \includegraphics[width=0.9\textwidth]{tabela.png}
\end{figure}

\noindent V analizi sem uporabljala vse stolpce, razen stolpca \texttt{DateTimeStartUTC}, saj je v 
okviru časa bolj relavanten stolpec \texttt{DateTimeStartCET}. Podatki so podani za obdobje od $1.~\text{novembra}~2021$ do $12.~\text{februarja}~2024$,
na vsakih $15$ minut. Tabela ima vsega skupaj $80064$ vrstic.

% =======================================================================================================================

\subsection{Odjem električne energije}

\noindent Slika~\ref{fig:odjem_EE} prikazuje odjem električne energije za obdobje od 
$1.~\text{novembra}~2021$ do $12.~\text{februarja}~2024$. 
Opazna je sezonskost; odjem je znatno večji jeseni in pozimi, zaradi povečane uporabe energije za ogrevanje in 
razsvetljevo (saj se število ur dnevne svetlobe podaljša). \\

\begin{figure}[h!]
    \centering
    \caption{Odjem električne energije, 2021-2024}\par\medskip
    \label{fig:odjem_EE}
    \includegraphics[width=0.9\textwidth]{odjem_EE.png}
\end{figure}

\noindent S Tabele~\ref{Tab:opisne_statistike} preberemo, da je povprečna poraba električne energije gospodinjskih odjemalcev
okrog $12240{,}53 $ MWh, minimalna dosežena vrednost je $3629{,}32$ MWh, maksimalna pa $28736{,}80$ MWh. Vrednosti varirajo
za okrog $4167{,}98$ MWh. \\

\begin{table}[!h]
    \centering
    \caption{Opisne statistike porabe električne energije, 2021-2024}\par\medskip
    \label{Tab:opisne_statistike}
    \begin{tabular}{c||c|c|c|c|c}
              & Min & Max & Povprečje & Mediana & Standardni odklon \\ \hline \hline
        Odjem [MWh] & $3629{,}32$ & $28736{,}80$ & $12240{,}53$ & $11708{,}50$ & $4167{,}98$ \\ 
    \end{tabular}
\end{table}

\noindent Odjem električne energije si poglejmo še na ravni tedna. Opazimo, da 
je od ponedeljka do petka odjem najmanjši ponoči in se veča vse do viška okrog 18 ure, nato pa hitro pade. 
V soboto in nedeljo pa je prvi višek porabe dopoldne, drugi pa okrog 18 ure, kar je opazno s Slike~\ref{fig:odjem_teden}, 
ki prikazuje odjem 
električne energije v drugem tednu septembra 2023. 
Imamo torej sezonskost na dnevni ravni.

\begin{figure}[h!]
    \centering
    \caption{Odjem električne energije po urah, drugi teden septembra 2023}\par\medskip
    \label{fig:odjem_teden}
    \includegraphics[width=0.9\textwidth]{odjem_teden.png}
\end{figure}

\noindent Zaključimo lahko, da je naša časovna vrsta visokofrekvenčna, ima sezonsko komponentno ter njeno povprečje ni konstantno.

% =======================================================================================================================

\subsection{Povezava med odjemom in temperaturo ter sevanjem}

\noindent Smislno se zdi, da obstaja povezava med odjemom električne energije ter
temperaturo in sevanjem. S pomočjo Slike~\ref{fig:temp_sevanje} ugotovimo, da
nižja temperatura pomeni višji odjem in obratno. 
Povezave med sevanjem in odjemom PA ni opaziti; sklepam da zato, ker 
ne analiziramo samooskrbnih odjemalcev (tisti ki imajo svojo sončno elektrarno). 

\begin{figure}[h!]
    \centering
    \caption{Povezava med odjemom in temperaturo ter sevanjem, 2021-2024}\par\medskip
    \label{fig:temp_sevanje}
    \includegraphics[width=0.9\textwidth]{temp_sevanje.png}
\end{figure}

\noindent V nadaljevanju bomo v upanju boljše napovedi v naše modele kot 
eksogeni spremenljivki vključili tudi temperaturo in sevanje. 


% =======================================================================================================================
% =======================================================================================================================


\section{Napredna analiza in izbira modela}

\subsection{Izbira družine modelov}

ARIMA je model, ki pri napovedovanju zajame vzorce, trende in sezonskost podatkov s kombinacijo preteklih 
vrednosti, razlik in napak. Ker pa imamo v podatkih očitno sezonskost, lahko ARIMO nadgradimo v SARIMO, ki dodatno
upošteva še sezonske vzorce. Ta družina modelov ima težavo predvsem pri napovedih, ko ima časovna vrsta 
skozi čas spremembo variance. Da bo naše napovedovanje bolj učinkovito, bomo SARIMA model nadgradili v 
model SARIMA-GARCH, saj se model GARCH uporablja ravno za modeliranje združevanja volatilnosti 
v podatke časovnih vrst.~\cite{ArimaGarch} \\

\noindent Naš model bo oblike: \\

TUKAJ BO FORMULA 

% =======================================================================================================================

\subsection{Odstranitev sezonskosti in pridobitev stacionarnosti}

Da bomo lahko indentificiralni potencialne modele, moramo najprej originalno časovno vrsto (Slika~\ref{fig:odjem_EE})
narediti stacionarno. \\

\noindent Ker so naši podatki volatilni najprej naredimo \textbf{logaritmične donose} 
(ang. \emph{log returns}). Če z $W_t$ označimo originalno časovno vrsto odjema električne energije, so logaritmični donosi
definirani kot časovna vrsta $ Y_t = \ln \left( \frac{W_t}{W_{t-1}} \right) $. Slednja časovna vrsta je prikazana na
Slika~\ref{fig:log_returns}.

\begin{figure}[h!]
    \centering
    \caption{Logaritmični donosi odjema električne energije, 2021-2024}\par\medskip
    \label{fig:log_returns}
    \includegraphics[width=0.9\textwidth]{log_returns.png}
\end{figure}

\begin{figure}[h!]
    \centering
    \caption{Vzorčna avtokorelacijska in parcialna avtokorelacija funkcija časovne vrste logaritmičnih donosov}\par\medskip
    \label{fig:log_returns_acf_pacf}
    \includegraphics[width=0.9\textwidth]{log_returns_acf_pacf.png}
\end{figure}

\noindent Slika~\ref{fig:log_returns_acf_pacf} prikazuje 
ACF (vzorčno avtokorelacijo) in PACF (vzorčna parcialna avtokorelacija) logaritmičnih donosov do odloga $1000$ (to je
malo manj kot dva tedna). Z grafov je očitno, da časovna vrsta ni stacionarna. Opazna je sezonska komponentna, in sicer $96$, 
kar je ravno en dan \footnote{Podatki so podani na $15$ minut in $15\,\text{min} \cdot 96 = 1440\,\text{min}$, kar je ravno en dan.}. \\

\noindent Da dosežemo stacionarnost, se je potrebno sezonskosti znebiti, zato bomo podatke \textbf{sezonsko diferencirali}.
Nova časovna vrsta bo $Z_t = Y_t - Y_{t-96}$. Prikazana je na Slika~\ref{fig:ts_diff}, njeni ACF in PACF pa na Slika~\ref{fig:ts_diff_acf_pacf}.

\begin{figure}[h!]
    \centering
    \caption{Časovna vrsta po sezonskem diferenciranju, 2021-2024}\par\medskip
    \label{fig:ts_diff}
    \includegraphics[width=0.9\textwidth]{ts_diff.png}
\end{figure}

\begin{figure}[h!]
    \centering
    \caption{Vzorčna avtokorelacijska in parcialna avtokorelacija funkcija časovne vrste po sezonskem diferenciranju}\par\medskip
    \label{fig:ts_diff_acf_pacf}
    \includegraphics[width=0.9\textwidth]{ts_diff_acf_pacf.png}
\end{figure}

\noindent Na grafu ACF opazimo ponavljanje vzorca, kar pomeni, da časovna vrsta $Z_t$ še kar ni stacionarna. 
Še enkrat jo diferenciramo in dobimo vrsto $X_t = Z_t - Z_{t-1}$. 
Prikazana je na Slika~\ref{fig:ts_diff_2}, njeni ACF in PACF pa na Slika~\ref{fig:ts_diff_2_acf_pacf}.

\begin{figure}[h!]
    \centering
    \caption{Časovna vrsta po prvem nesezonskem diferenciranju, 2021-2024}\par\medskip
    \label{fig:ts_diff_2}
    \includegraphics[width=0.9\textwidth]{ts_diff_2.png}
\end{figure}

\begin{figure}[h!]
    \centering
    \caption{Vzorčna avtokorelacijska in parcialna avtokorelacija funkcija časovne vrste po prvem nesezonskem diferenciranju}\par\medskip
    \label{fig:ts_diff_2_acf_pacf}
    \includegraphics[width=0.9\textwidth]{ts_diff_2_acf_pacf.png}
\end{figure}

\begin{figure}[h!]
    \caption{Vzorčna avtokorelacijska in parcialna avtokorelacija funkcija časovne vrste po prvem nesezonskem diferenciranju, odlogi do 100}\par\medskip
    \centering
    \label{fig:ts_diff_2_acf_pacf_do_100}
    \includegraphics[width=0.9\textwidth]{ts_diff_2_acf_pacf_do_100.png}
\end{figure}

\noindent Dobljena časovna vrsta $X_t$ na pogladi ACF in PACF (Slika~\ref{fig:ts_diff_2_acf_pacf}) 
zgleda stacionarno in tudi formalni testi ADF, 
KPSS in Phillips-Perron potrdijo njeno stacionarnost. 
Časovna vrsta je torej primerna za izbero parametrov modela SARIMA. 

% =======================================================================================================================

\subsection{Identifikacija modela SARIMA}

\noindent Na podlagi ACF in PACF (Slika~\ref{fig:ts_diff_2_acf_pacf}) stacionarne časovne vrste $X_t$, izberimo parametre 
modela SARIMA(p, d, q)(P, D, Q)[S]. Parametre lahko razdelimo na nesezonske (p, d, q) in sezonske (P, D, Q, S)~\cite{SARIMA_param}:

\begin{itemize}
    \item p \dots koliko korakov nazaj bomo gledali (preberemo iz grafa PACF)
    \item d \dots kolikokrat smo diferencirali 
    \item q \dots število zgodovinskih napak, ki vplivajo na trenutno vrednost (preberemo iz grafa ACF)
    \item P \dots red sezonskega AR(P)
    \item D \dots kolikokrat smo sezonsko diferencirali
    \item Q \dots red sezonskega MA(Q)
    \item S \dots perioda
\end{itemize}

\noindent Ker smo časovno vrsto enkrat sezonsko diferencirali bo $\text{D} = 1$ in ker smo jo enkrat 
navadno diferencirali bo $\text{d} = 1$. Perioda je enaka $96$, torej je $\text{S} = 96$. \\

\noindent Za določitev sezonskih parametrov P in Q gledamo korelacije pri odlogih, ki so večkratniki periode S. Pri
PACF visoko korelacijo opazimo predvsem pri $96$ in $192$, nato pa se z vsako dodatno periodo manjša. Parameter P je torej 
$1$ ali več; predlagala bi $1$, $2$ ali $3$. 
Pri ACF pa je občutna korelacija zgolj pri $96$, zato izberemo $\text{Q} = 1$. \\

\noindent Za lažjo določitev nesezonskih parametrov p in q bomo gledali ACF in PACF do prve periode (torej do odloga 96). 
Slednje je prikazano na Slika~\ref{fig:ts_diff_2_acf_pacf_do_100}. Tako iz PACF, kot tudi iz ACF, je opazna večja korelacija
pri prvih nekaj urah in v uri tik pred periodo. V modelu bomo zato zagotovo vključili prvih nekaj ur, saj le-te kažejo močan vpliv. \\


\noindent Izbrala sem nekaj potencialnih modelov SARIMA, kjer sem kot eksogeno spremenljivko podala temperaturo in sevanje.
Modele sem trenirala na $75~\%$ podatkov, to je od $1.~\text{novembra}~2021$ do $4.~\text{avgusta}~2023$. Na preostanku podatkov 
pa sem izvajala teste napovedi. 
Vrednosti kriterija AIC za posamezne modele so prikazane v Tabeli~\ref{Tab:SARIMA_AIC}. 
Najmanjšo vrednostjo kriterija AIC ima model SARIMA(4, 1, 5)(0, 1, 0)[96]. \\

\noindent S Tabele~\ref{Tab:SARIMA_AIC} je razvidno, da sem za sezonska parametra P in Q v vseh primerih izbrala 
vrednost $0$, čeprav sklepam, da bi bile bolj optimalne višje vrednosti. Te modele sem poskusila zagnati, 
vendar moj računalnik ni vrnil nobenega rezultata, ker očitno ni dovolj zmogljiv. 

\begin{table}[!ht]
    \centering
    \caption{Vrednost kriterija AIC za izbrane modele iz družine SARIMA}\par\medskip
    \label{Tab:SARIMA_AIC}
    \begin{tabular}{c|c}
        Model & AIC \\ \hline
        SARIMA(1,1,0)(0,1,0)[96] & $-338588{,}046$ \\ 
        SARIMA(0,1,1)(0,1,0)[96] & $-346718{,}519$ \\ 
        SARIMA(1,1,1)(0,1,0)[96] & $-346768{,}583$ \\ 
        SARIMA(2,1,1)(0,1,0)[96] & $-347555{,}507$ \\ 
        SARIMA(3,1,2)(0,1,0)[96] & $-347573{,}394$ \\ 
        SARIMA(4,1,3)(0,1,0)[96] & $-278981{,}698$ \\ 
        SARIMA(5,1,4)(0,1,0)[96] & $-345287{,}413$ \\ 
        SARIMA(5,1,5)(0,1,0)[96] & $-345310{,}105$ \\ 
        SARIMA(4,1,5)(0,1,0)[96] & $\mathbf{-347619{,}304}$ \\ 
        SARIMA(6,1,5)(0,1,0)[96] & $-345325{,}842$ \\ 
        SARIMA(6,1,6)(0,1,0)[96] & $-345342{,}972$ \\ 
        SARIMA(5,1,6)(0,1,0)[96] & $-345351{,}794$ \\
    \end{tabular}
\end{table}

\noindent Izbran imamo model SARIMA, v naslednjem koraku pa na podoben način izberimo še model GARCH. 

% =======================================================================================================================

\subsection{Izbira modela SARIMA-GARCH}

Model GARCH(p, q) bomo konstruirali na rezidualih izbranega modela SARIMA. Preizkusili bomo $6$ kombinacij 
parametrov p in q, in sicer $(1,1), (1,2), (2,1), (2,2), (1,3)$ ter $(3,1)$. 
Na podlagi vrednosti kriterija AIC se odločimo za model SARIMA(4, 1, 5)(0, 1, 0)[96]-GARCH(1, 3), saj
je iz Tabele~\ref{Tab:GARCH_AIC} razvidno, da ima najmanjši AIC. 

\begin{table}[!ht]
    \centering
    \caption{Vrednost kriterija AIC za izbrane modele SARIMA(4, 1, 5)(0, 1, 0)[96]-GARCH(p, q)}\par\medskip
    \label{Tab:GARCH_AIC}
    \begin{tabular}{c|c}
        SARIMA-GARCH(p,q) & AIC \\ \hline
        (0, 0) & $-347619{,}304$ \\ 
        (1, 1) & $-365754{,}448$ \\ 
        (1, 2) & $-366056{,}218$ \\ 
        (2, 1) & $-365434{,}577$ \\ 
        (2, 2) & $-365843{,}673$ \\ 
        (1, 3) & $\mathbf{-366134{,}335}$ \\ 
        (3, 1) & $-365252{,}576$ \\ 
    \end{tabular}
\end{table}


% =======================================================================================================================

\subsection{Izbran model}

Na podlagi vrednosti kriterija AIC se odločimo za model SARIMA(4, 1, 5)(0, 1, 0)[96]-GARCH(1, 3). 
V matematičnem jeziku je oblike:


% =======================================================================================================================
% =======================================================================================================================

\pagebreak

\section{Testiranje izbranega modela SARIMA-GARCH}

Izbran model SARIMA-GARCH uporabimo za napovedovanje odjema električne energije za različne dni v testnem obdobju
(od $5.~\text{avgusta}~2023$ do $12.~\text{februarja}~2024$). Izbrala sem si $6$ različnih dni, narisala njihove napovedi ter
jih prikazala na Sliki~\ref{fig:napovedi_vse}.

\begin{figure}[!ht]
    \centering
    \caption{Napovedi odjema električne energije za izbrane datume}\par\medskip
    \label{fig:napovedi_vse}
    \begin{minipage}[c]{0.48\linewidth}
        \includegraphics[width=\linewidth]{napoved_1.png}
    \end{minipage}
    \hfill
    \begin{minipage}[c]{0.48\linewidth}
        \includegraphics[width=\linewidth]{napoved_2.png}
    \end{minipage}
\end{figure}
\begin{figure}[!ht]
    \centering
    \begin{minipage}[c]{0.48\linewidth}
        \includegraphics[width=\linewidth]{napoved_3.png}
    \end{minipage}
    \hfill
    \begin{minipage}[c]{0.48\linewidth}
        \includegraphics[width=\linewidth]{napoved_4.png}
    \end{minipage}
\end{figure}
\begin{figure}[!ht]
    \centering
    \begin{minipage}[c]{0.48\linewidth}
        \includegraphics[width=\linewidth]{napoved_5.png}
    \end{minipage}
    \hfill
    \begin{minipage}[c]{0.48\linewidth}
        \includegraphics[width=\linewidth]{napoved_6.png}
    \end{minipage}
\end{figure}

\noindent Prileganje napovedi dejanski vrednosti se zdi zelo dobra, vseeno pa si
poglejmo napaki RMSE (ang. \emph{Root-mean-square deviation}) in 
MAPE (ang. \emph{Mean absolute percentage error}), ki ju izračunamo po formulah:

$$
RMSE = \sqrt{\frac{1}{96}\sum_{t=1}^{96}{(W_t-\hat{W_t})^2}} \quad \textrm{in} \quad
MAPE = \frac{1}{96}\sum_{t=1}^{96}{\frac{W_t-\hat{W_t}}{W_t}} \,,
$$

\noindent kjer je $W_t$ dejanska vrednost odjema, $\hat{W_t}$ pa napovedana. \\

\noindent Vrednosti napak RMSE in MAPE za izbrane napovedi so zapisane v Tabeli~\ref{Tab:RMSE_MAPE} in 
v povprečju znašajo RMSE $261{,}926$, MAPE pa $1{,}478~\%$. \\


\begin{table}[!ht]
    \centering
    \caption{Vrednost napake RMSE in MAPE za izbrane datume}\par\medskip
    \label{Tab:RMSE_MAPE}
    \begin{tabular}{c|c|c}
        Datum & RMSE & MAPE \\ \hline
        5.avg.23 & 156,600 & 1,104 \\ 
        24.sep.23 & 365,372 & 2,392 \\ 
        16.nov.23 & 176,901 & 1,199 \\ 
        30.dec.23 & 224,123 & 1,046 \\ 
        7.jan.23 & 399,578 & 1,839 \\ 
        12.feb.23 & 248,981 & 1,287 \\ \hline
        Povprečje & 261,926 & 1,478 \\ 
    \end{tabular}
\end{table}


\noindent Napaki RMSE in MAPE sem izbračunala še posebej za zadnji teden septembra 2023 in 
prvi teden februarja 2024. Rezultati so prikazani v Tabeli 





% =======================================================================================================================
% =======================================================================================================================

\pagebreak

\section{Zaključek}



% =======================================================================================================================
% =======================================================================================================================

\pagebreak

\bibliographystyle{abbrv}
\bibliography{literatura.bib}


\end{document}
